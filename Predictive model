# Importing necessary libraries
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
get_ipython().run_line_magic('matplotlib', 'inline')
import warnings
warnings.filterwarnings('ignore')

#Installing pmdarima package
get_ipython().system(' pip install pmdarima')

# Importing auto_arima 
from pmdarima.arima import auto_arima

#Read the crime dataset --> IMPORT OUR DATA SET HERE
sales_data = pd.read_csv('/content/data/residential_b2020.csv')

#Convert the month column to datetime and set the index of the Month 
sales_data['MONTH']=pd.to_datetime(sales_data['MONTH'])
sales_data.set_index('MONTH',inplace=True) 

#To understand the pattern
sales_data.plot()

#Testing for stationarity --> it should say 'False'
from pmdarima.arima import ADFTest
adf_test = ADFTest(alpha = 0.05)
adf_test.should_diff(sales_data)

#Spliting the dataset into train and test --> OUR DATA + CHANGE NUMBER IN BRACKETS 
train = sales_data['01 2015': '01 2020']
test = sales_data['01 2020':] 

#Building ARIMA model 
arima_model =  auto_arima(train,start_p=0, d=1, start_q=0, 
                          max_p=5, max_d=5, max_q=5, start_P=0, 
                          D=1, start_Q=0, max_P=5, max_D=5,
                          max_Q=5, m=12, seasonal=True, 
                          error_action='warn',trace = True,
                          supress_warnings=True,stepwise = True,
                          random_state=20,n_fits = 50 )
arima_model.summary()

#Finding predicted crime values 
prediction = pd.DataFrame(arima_model.predict(n_periods = 12),index=test.index)
prediction.columns = ['predicted_sales']
prediction

#Finding prediction interval
conf_int  = arima_model.predict(11,return_conf_int=True,alpha=0.05)
print(conf_int)

#Plotting predicted values and real values from 2020
plt.figure(figsize=(8,5))
plt.plot(prediction,label="Without COVID trend")
plt.plot(sales_data,label="Real trend")
plt.legend(loc = 'Left corner')
plt.title("RESIDENTIAL BURGLARIES FROM 2015 TO 2020 IN LONDON")
plt.xlabel("Time")
plt.ylabel("Residential burglary's values")
plt.show()

#Finding r2 --> OUR DATA
from sklearn.metrics import r2_score
test['predicted_sales'] = prediction
r2_score(test['Champagne sales'], test['predicted_sales'])


#changing arrays to csv format to plot the output predicted data 

https://stackoverflow.com/questions/6081008/dump-a-numpy-array-into-a-csv-file
https://machinelearningmastery.com/how-to-save-a-numpy-array-to-file-for-machine-learning/#:~:text=It%20can%20be%20convenient%20to,the%20array%20into%20CSV%20format

#convert array to numpy
np.array(test)
https://stackoverflow.com/questions/5674960/efficient-python-array-to-numpy-array-conversion

# save numpy array as csv file
from numpy import asarray
from numpy import savetxt

# define data
a = asarray([[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]])

# save to csv file
savetxt('predictiondata.csv', a, delimiter=',')

